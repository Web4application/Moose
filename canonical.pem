#!/usr/bin/env bash
# ===============================================
# All-in-one AuraxLSL Runtime + Elasticsearch + HTTPS
# ===============================================

ES_BINARY=/home/grant/elasticsearch-0.18.7/bin/elasticsearch
ES_HOST="http://localhost:9200"
ES_INDEX="auraxlsl_runs"
APP_PORT=8000

# SSL files (update paths to your .pem files)
SSL_CERT="/home/grant/certs/server.pem"
SSL_KEY="/home/grant/certs/server.key"

# -------------------------------
# Start Elasticsearch
# -------------------------------
start_es() {
    echo "Starting Elasticsearch..."
    $ES_BINARY &
    ES_PID=$!
    echo "Elasticsearch PID: $ES_PID"
}

# -------------------------------
# Wait for Elasticsearch
# -------------------------------
wait_for_es() {
    echo "Waiting for Elasticsearch to be ready..."
    for i in {1..15}; do
        if curl -s "$ES_HOST" > /dev/null; then
            echo "Elasticsearch ready!"
            return
        fi
        sleep 2
    done
    echo "Elasticsearch not reachable. Exiting."
    exit 1
}

# -------------------------------
# Run AuraxLSL FastAPI Runtime with HTTPS
# -------------------------------
run_auraxlsl() {
    python3 - <<'PYTHON_CODE'
import time
import requests
from elasticsearch import Elasticsearch
from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn
import os

ES_HOST = os.getenv("ES_HOST", "http://localhost:9200")
ES_INDEX = os.getenv("ES_INDEX", "auraxlsl_runs")
APP_PORT = int(os.getenv("PORT", 8000))
SSL_CERT = os.getenv("SSL_CERT", "/home/grant/certs/server.pem")
SSL_KEY = os.getenv("SSL_KEY", "/home/grant/certs/server.key")

def wait_for_es(timeout=30):
    es_ready = False
    start = time.time()
    while not es_ready and (time.time() - start) < timeout:
        try:
            r = requests.get(f"{ES_HOST}")
            if r.status_code == 200:
                es_ready = True
                print(f"Elasticsearch ready at {ES_HOST}")
                return True
        except requests.exceptions.ConnectionError:
            pass
        print("Waiting for Elasticsearch...")
        time.sleep(2)
    raise RuntimeError("Elasticsearch not reachable within timeout.")

def get_es_client():
    return Elasticsearch([ES_HOST])

def ensure_index(es, index_name):
    if not es.indices.exists(index=index_name):
        es.indices.create(index=index_name)
        print(f"Created Elasticsearch index: {index_name}")

app = FastAPI(title="AuraxLSL Runtime HTTPS")

class Run(BaseModel):
    name: str
    data: dict

@app.post("/run")
def run_auraxlsl(run: Run):
    es = get_es_client()
    doc = {"name": run.name, "data": run.data, "timestamp": time.time()}
    res = es.index(index=ES_INDEX, document=doc)
    return {"status": "ok", "id": res['_id']}

@app.get("/health")
def health():
    return {"status": "ok"}

if __name__ == "__main__":
    wait_for_es()
    es_client = get_es_client()
    ensure_index(es_client, ES_INDEX)
    print(f"AuraxLSL runtime HTTPS starting on port {APP_PORT}...")
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=APP_PORT,
        ssl_certfile=SSL_CERT,
        ssl_keyfile=SSL_KEY
    )
PYTHON_CODE
}

# -------------------------------
# Main
# -------------------------------
start_es
wait_for_es
run_auraxlsl
